This code mostly written by AI (either codex, tabnine, or co-pilot, depending on the mood of the day).